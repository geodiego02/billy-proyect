<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Split Files App</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

    
</head>
<body>
<div class="container mt-4">
    <h1>Aplicación de división de archivos</h1>
	<div></div>
    <!-- FORMULARIO DE SUBIDA DE ARCHIVO -->
    <div class="card mb-3">
        <div class="card-header">Subir y Segmentar Archivo</div>
        <div class="card-body">
            <form id="uploadForm" onsubmit="return submitForm(event)">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">Seleccionar Archivo</label>
                    <input class="form-control"
                           type="file"
                           id="fileInput"
                           name="file"
                           required
                           onchange="storeFileName(event)">
                </div>
                <div class="mb-3">
                    <label for="segmentSizeKB" class="form-label">Tamaño Segmento (KB)</label>
                    <input class="form-control"
                           type="number"
                           id="segmentSizeKB"
                           name="segmentSizeKB"
                           min="16"
                           value="1024"
                           required>
                </div>
                <input type="hidden" id="sessionId" name="sessionId" value="abc123" />
                <input type="hidden" id="originalFileName" name="originalFileName" />

                <!-- Botón deshabilitado por defecto; se habilitará cuando el usuario seleccione archivo -->
                <button id="submitButton" class="btn btn-primary" type="submit" disabled>
                    Subir y Segmentar
                </button>
            </form>
        </div>
    </div>

    <!-- PROGRESO -->
    <div class="card mb-3">
        <div class="card-header">Progreso de Segmentación</div>
        <div class="card-body">
            <p id="progressText">Aún no iniciado</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar"
                     role="progressbar"
                     style="width: 0%;"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
            </div>
        </div>
    </div>

    <!-- LISTADO DE SEGMENTOS -->
    <div class="card mb-3">
        <div class="card-header">Segmentos Generados</div>
        <div class="card-body">
            <ul id="segmentList" class="list-group"></ul>
        </div>
    </div>

    <!-- FORMULARIO ENVÍO POR CORREO -->
    <div class="card mb-3">
        <div class="card-header">Enviar Segmentos por Correo</div>
        <div class="card-body">
            <form id="mailForm" onsubmit="return sendMail(event)">
                <div class="mb-3">
                    <label for="toEmail" class="form-label">Destinatario</label>
                    <input class="form-control"
                           type="email"
                           id="toEmail"
                           name="toEmail"
                           required>
                </div>
                <!-- Spinner/mensaje oculto por defecto -->
				<div id="mailLoading" style="display: none;">
				    <div class="spinner-border text-success" role="status">
				        <span class="visually-hidden">Enviando...</span>
				    </div>
				    <span class="ms-2">Enviando correo...</span>
				</div>
                <button id="sendMailButton" class="btn btn-success" type="submit">Enviar Segmentos</button>
            </form>
            <p id="mailStatus"></p>
        </div>
    </div>
</div>

<!-- Bootstrap JS (opcional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- SockJS y STOMP para WebSocket -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let segmentsList = [];

    // Conectarse al WebSocket al cargar la página
    window.addEventListener('load', () => {
        connectWebSocket();
    });

    // 1) Conectar al WebSocket (STOMP)
    function connectWebSocket() {
        const socket = new SockJS('/ws-split');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            const sessionId = document.getElementById("sessionId").value;
            stompClient.subscribe('/topic/progress/' + sessionId, (message) => {
                handleProgressUpdate(message.body);
            });
        });
    }

    // 2) Al seleccionar el archivo, guardamos su nombre y habilitamos el botón
    function storeFileName(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById("originalFileName").value = file.name;
            // Habilita el botón
            document.getElementById("submitButton").disabled = false;
        } else {
            // Si no hay archivo, permanece deshabilitado
            document.getElementById("submitButton").disabled = true;
        }
    }

    // 3) Al hacer submit del formulario
    async function submitForm(event) {
        event.preventDefault(); // Evita recarga

        // Deshabilita el botón de subir
        document.getElementById("submitButton").disabled = true;
        segmentsList = [];

        const form = document.getElementById("uploadForm");
        const formData = new FormData(form);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.text();
            console.log('Resultado upload:', result);

            // Iniciamos la barra de progreso en 0
            document.getElementById("progressText").textContent = "Procesando...";
            document.getElementById("progressBar").style.width = '0%';

        } catch (error) {
            console.error('Error al subir archivo:', error);
        }
        return false;
    }

    // 4) Maneja notificaciones de progreso
    function handleProgressUpdate(msg) {
        console.log("Progreso recibido: " + msg);
        const progressText = document.getElementById("progressText");
        const progressBar = document.getElementById("progressBar");

        if (msg === 'DONE') {
            progressText.textContent = "¡Segmentación completada!";
            progressBar.style.width = '100%';

            const originalName = document.getElementById("originalFileName").value;
            // Al terminar, listar archivos
            fetchSegmentsList(originalName)
                .then(() => {
                    // Limpia el input para forzar nueva selección si se quiere re-subir
                    document.getElementById("fileInput").value = null;
                    // El usuario debe volver a seleccionar un archivo => 
                    // dejamos el botón deshabilitado hasta que el user elija otro
                    document.getElementById("submitButton").disabled = true;
                });

        } else {
            // Asumimos que es un porcentaje
            const percent = parseFloat(msg);
            if (!isNaN(percent)) {
                progressText.textContent = "Progreso: " + percent.toFixed(2) + "%";
                progressBar.style.width = percent + '%';
            }
        }
    }

    // 5) Obtener la lista de segmentos desde el backend
    async function fetchSegmentsList(originalName) {
        if (!originalName) return;
        try {
            const response = await fetch('/listSegments?originalName=' + encodeURIComponent(originalName));
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            segmentsList = await response.json();
            renderSegments(segmentsList);
        } catch (err) {
            console.error("Error al listar segmentos:", err);
        }
    }

    // Renderizar los enlaces de los segmentos
    function renderSegments(segments) {
        const segmentListElem = document.getElementById("segmentList");
        segmentListElem.innerHTML = "";

        // Ejemplo: "archivo.pdf.0", "archivo.pdf.1"
        segments.forEach(segName => {
            const li = document.createElement("li");
            li.classList.add("list-group-item", "d-flex", "align-items-center");
            

            const link = document.createElement("a");
            link.href = "/download/" + segName;
            link.textContent = segName;

            li.appendChild(link);
            segmentListElem.appendChild(li);
        });
    }

    // 7) Enviar los segmentos por correo
    async function sendMail(event) {
        event.preventDefault();
        const toEmail = document.getElementById("toEmail").value;

        if (!segmentsList || segmentsList.length === 0) {
            document.getElementById("mailStatus").textContent = 
                "No hay segmentos para enviar.";
            return false;
        }
     	// 1) Mostrar spinner y deshabilitar botón
        document.getElementById("mailLoading").style.display = "inline-block";
        document.getElementById("sendMailButton").disabled = true;
        document.getElementById("mailStatus").textContent = ""; // Limpia mensajes previos

        const formData = new URLSearchParams();
        formData.append("toEmail", toEmail);
        segmentsList.forEach(seg => {
            formData.append("segmentNames", seg);
        });

        try {
            const response = await fetch('/sendEmail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            });
            const result = await response.text();
            document.getElementById("mailStatus").textContent = result;
        } catch (error) {
            document.getElementById("mailStatus").textContent = "Error enviando correo: " + error;
        }finally {
            // 2) Ocultar spinner y habilitar botón
            document.getElementById("mailLoading").style.display = "none";
            document.getElementById("sendMailButton").disabled = false;
        }
        return false;
    }
</script>
</body>
</html>
